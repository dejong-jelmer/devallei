<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <script src="jquery-3.2.1.js"></script>
     </head>
    <body>
    <input type="hidden" id="signOutStatus">
    <input type="hidden" id="signOutId">
    <input type="hidden" id="signOutReason">
    <table>
        <tr>
            <td>Coachgroepen</td>
            <td>       -----------------  </td>
            <td>Leerlingen</td>
        </tr>
        <tr>
            <td>
                <div id="coachGroupOutput"></div>
            </td>
            <td></td>
            <td>
                <div id="studentsOutput"></div>
            </td>
        </tr>
    </table>
        <script>
            jQuery(document).ready(function(){
                getAllCoachGroups();               
            });
            
        </script>
    </body>
</html>
<script>
    // get all coachgroups from API
    // @return JSON {all coach.groups}
    // @return button value coach.id 
    function getAllCoachGroups()
    {
        var url = "http://devallei.dev/api/v1/coachgroep/alle";

        return $.getJSON(url, function(data){
                        
            $.each(data, function(i, coach){
                // console.log('i = '+ i);
                // console.log('coach id = '+ coach.id);
                // console.log('coach naam = '+ coach.coach);

                                                
                $("#coachGroupOutput").append("<button class='coachGroupButton' value='"+coach.id+"'>"+coach.coach+"</button>"+" <br>");
            
            });

            $('.coachGroupButton').click(function(){
                
                getCoachGroupStudents(this.value);


            });
        
        });
    }

    //  get all students from API related to coachgroup
    //  @var coach.id (clicked button value)
    //  @return JSON {all the choachgroups students student[studentdata] / student[status]}
    //  @return button value student.id
    function getCoachGroupStudents(id)
    {
        var url = "http://devallei.dev/api/v1/coachgroep/"+id

        $("#studentsOutput").empty();
                            
        return $.getJSON(url, function(data){  
            
            $.each(data, function(i, student){
                // console.log('index = '+ i);
                // console.log('student id = '+ student.id);
                // console.log('student status_id = '+ student.status_id);
                // console.log('student naam = '+ student.studentdata.voornaam);
                // console.log('student status = '+ student.status.status);

            
                $("#studentsOutput").append("<button id='studentBtn_"+student.id+"' name='"+student.studentdata.voornaam+"' class='studentButton' type='button' value='"+student.id+"'>"+"id=:"+student.id+": "+student.studentdata.voornaam+"</button> <br>");

                if(student.status.status == "aanwezig") {
                    $("#studentBtn_"+student.id).css({'background': 'green'}).removeClass("afwezig").addClass("aanwezig");
                }

                if(student.status.status == "afwezig") {
                    $("#studentBtn_"+student.id).css({'background':'red'}).removeClass("aanwezig").addClass("afwezig");
                }

                if(student.status.status == "tussendoor uit") {
                    $("#studentBtn_"+student.id).css({'background':'orange'}).removeClass("aanwezig").addClass("tussendoor_uit");
                }          
            });

            $('.studentButton').click(function() {
                console.log(this.name);
                var studentId = this.value;
                var studentName = this.name;
                var url = 'http://devallei.dev/api/v1/leerlingen/status/'+studentId;
                $.getJSON(url, function(data) {
                    if (data.status !== "aanwezig") {
                        // console.log(studentId);
                        if (confirm("Hallo "+studentName+" wil je je aanmelden?")) {

                            updateStudentStatus(studentId)
                        }
                    }

                    if (data.status == "aanwezig") {
                        if(confirm("Wil je je afmelden?")) {
                            var win = openWindow(studentId);
                            
                            var timer = setInterval(function() {   
                                if(win.closed) {  
                                    clearInterval(timer);  
                                    var studentId = document.getElementById("signOutId").value;
                                    var status = document.getElementById("signOutStatus").value;
                                    if(status == "tussendoor_uit") {
                                        var reason = '';
                                        while (reason == '') {
                                            if(reason = prompt("Wat is de reden?")) {
                                                updateStudentStatus(studentId, status, reason); 

                                            }
                                        }
                                    } else {
                                        
                                        updateStudentStatus(studentId, status, reason); 
                                    }
                                    
                                    
                                    
                                }  
                            }, 100); 
                        }
                    }
                });     
            });
        });  
    }


    function updateStudentStatus(student_id, status, reason) 
    {
        
        var url = 'http://devallei.dev/api/v1/leerlingen/updatestatus/'+student_id;

       var jqxhr = $.post(url, {
            'status':status, 
            'reden':reason
        },  function(data, status) 
            {
                console.log(data);
                console.log(status);
                
            }, "json")
                .done(function(data){
                    if(data.status == "afwezig") {
                        
                        $("#studentBtn_"+student_id).css({'background': 'red'}).removeClass("aanwezig").addClass("afwezig");
                    } else if (data.status == "aanwezig"){
                        $("#studentBtn_"+student_id).css({'background': 'green'}).removeClass("afwezig").addClass("aanwezig");
                    } else if (data.status == "tussendoor uit") {
                        $("#studentBtn_"+student_id).css({'background': 'orange'}).removeClass("aanwezig").addClass("tussendoor_uit");
                    }
                });    
    }

    function openWindow(studentId) {
        var i; 
        var options = [
            {
               value: '',
               text: '-- Maak keuze --'
            },
            {
               value: 'afmelden',
               text: 'Afmelden'
            }, 
            {
               value: 'tussendoor_uit',
               text: 'Tussendoor uit'
            }
        ],
        newWindow = window.open("", null, "height=200,width=400,status=yes,toolbar=no,menubar=no,location=no");  
        
        newWindow.document.write("<select onChange='window.opener.setValue("+studentId+", this.value);window.close();'>");
        
        for (i=0; i<options.length; i++) {
            newWindow.document.write("<option value='"+options[i].value+"'>");  
            newWindow.document.write(options[i].text);  
            newWindow.document.write("</option>");
        }
        
        newWindow.document.write("</select>");
        
        return newWindow;
    }

    function setValue(studentId, studentStatus) {
        
        
        document.getElementById('signOutId').value = studentId;
        document.getElementById('signOutStatus').value = studentStatus;
        // document.getElementById('signOutReason').value = studentReason;
    }
</script>  
